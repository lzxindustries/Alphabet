version: 2.1
orbs:
  win: circleci/windows@2.2.0


workflows:
  build_and_package:
    jobs:
      - build-linux:
          context:
            - org-global
      - build-windows:
          context:
            - org-global
jobs:
  build-windows:
    executor: win/default
    steps:
      - checkout
      - run: 
          name: "Install Dependencies"
          command: |
            $WebClient = New-Object System.Net.WebClient
            $WebClient.DownloadFile("https://aka.ms/vs/16/release/vs_community.exe","C:\vs_community.exe")
            C:\vs_community.exe --add Microsoft.VisualStudio.Workload.NetWeb --quiet --wait --norestart --noUpdateInstaller
            cinst --no-progress -y 7zip
            pip install cmake
            pip install aqtinstall
            mkdir build
            cd build
            python -m aqt install 5.14.2 windows desktop win64_msvc2017_64
      - run:
          name: "Update Submodules"
          command: |
            git submodule update --init --recursive --merge .
      - run:
          name: "Build & Package Project"
          command: |
            cd build
            cmake -G "Visual Studio 16 2019" -A x64 -DQt5_DIR=C:\Qt5.14.2\5.14.2\msvc2017_64\lib\cmake\Qt5 ..
            cmake --build -DQt5_DIR=C:\Qt5.14.2\5.14.2\msvc2017_64\lib\cmake\Qt5 . --config Release
            cmake --build -DQt5_DIR=C:\Qt5.14.2\5.14.2\msvc2017_64\lib\cmake\Qt5 . --target bundle --config Release
      - store_artifacts:
          path: /root/project/build

  build-linux:
    docker:
      - image: creatorlars/lzxembedded-base:V0.1
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD
    steps:
      - checkout
      - run:
          name: "Update Build Environment"
          command: |
            apt-get -q update
            apt-get install -y -q cmake ninja-build make g++ rpm p7zip-full
      - run:
          name: "Install Dependencies"
          command: |
            apt-get install -y -q qtbase5-dev qt5-style-plugins
            wget -q -O linuxdeployqt https://github.com/probonopd/linuxdeployqt/releases/download/7/linuxdeployqt-7-x86_64.AppImage
            install linuxdeployqt /usr/local/bin/
      - run:
          name: "Update Submodules"
          command: |
            git submodule update --init --recursive --merge .
      - run:
          name: "Build & Package Project"
          command: |
            mkdir build
            cd build
            cmake ..
            cmake --build . --target bundle
      - store_artifacts:
          path: /root/project/build
          


